<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Quản lý Nhân sự & Xuất Phiếu Lương</title>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='style.css') }}"
    />
  </head>
  <body>
    <div class="container">
      <header>
        <h1>Quản lý Nhân sự & Xuất Phiếu Lương</h1>
        <p class="subtitle">
          Upload file Excel, chọn nhân viên và xuất phiếu lương cá nhân
        </p>
      </header>

      <!-- Upload Section -->
      <section class="card upload-section">
        <h2>Upload File Excel</h2>
        <form id="uploadForm" enctype="multipart/form-data">
          <div class="file-input-wrapper">
            <input type="file" id="fileInput" name="file" accept=".xlsx,.xls" />
            <label for="fileInput" class="file-label">
              <span class="file-icon">[FILE]</span>
              <span class="file-text">Chọn file Excel (.xlsx, .xls)</span>
            </label>
            <span id="fileName" class="file-name"></span>
          </div>
          <button type="submit" class="btn btn-primary">Upload</button>
        </form>
        <div id="uploadStatus" class="status-message"></div>
        <div id="dataInfo" class="data-info" style="display: none">
          <p>
            <strong>Số nhân viên:</strong> <span id="employeeCount">0</span>
          </p>
        </div>
      </section>

      <!-- Email Status Summary Section -->
      <section class="card email-summary-section" id="emailSummarySection" style="display: none">
        <h2>Trạng thái gửi Email</h2>
        <div class="email-summary">
          <div class="summary-stats">
            <div class="stat-item stat-total">
              <span class="stat-label">Tổng số:</span>
              <span class="stat-value" id="statTotal">0</span>
            </div>
            <div class="stat-item stat-sent">
              <span class="stat-label">Đã gửi:</span>
              <span class="stat-value" id="statSent">0</span>
            </div>
            <div class="stat-item stat-pending">
              <span class="stat-label">Chưa gửi:</span>
              <span class="stat-value" id="statPending">0</span>
            </div>
            <div class="stat-item stat-failed">
              <span class="stat-label">Thất bại:</span>
              <span class="stat-value" id="statFailed">0</span>
            </div>
          </div>
          <div class="email-list-toggle">
            <button type="button" class="btn btn-secondary" onclick="showEmailList('all')">Xem tất cả</button>
            <button type="button" class="btn btn-secondary" onclick="showEmailList('pending')">Xem chưa gửi</button>
            <button type="button" class="btn btn-secondary" onclick="showEmailList('sent')">Xem đã gửi</button>
          </div>
          <div id="emailListContainer" class="email-list-container" style="display: none">
            <table class="email-status-table">
              <thead>
                <tr>
                  <th>STT</th>
                  <th>Họ tên</th>
                  <th>Email</th>
                  <th>Trạng thái</th>
                  <th>Thời gian</th>
                </tr>
              </thead>
              <tbody id="emailListBody"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- Email Configuration Section -->
      <section
        class="card email-config-section"
        id="emailConfigSection"
        style="display: none"
      >
        <h2>Cấu hình Email</h2>
        <div class="email-config-form">
          <div class="form-row">
            <div class="form-group">
              <label>SMTP Server:</label>
              <input
                type="text"
                id="smtpServer"
                value="smtp.gmail.com"
                placeholder="smtp.gmail.com"
              />
            </div>
            <div class="form-group">
              <label>Port:</label>
              <input
                type="number"
                id="smtpPort"
                value="587"
                placeholder="587"
              />
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Email gửi:</label>
              <input
                type="email"
                id="senderEmail"
                placeholder="your-email@gmail.com"
              />
            </div>
            <div class="form-group">
              <label>App Password:</label>
              <input
                type="password"
                id="senderPassword"
                placeholder="App Password (không phải mật khẩu Gmail)"
              />
            </div>
          </div>
          <div class="form-actions">
            <button
              type="button"
              class="btn btn-primary"
              onclick="saveEmailConfig()"
            >
              Lưu cấu hình
            </button>
            <span id="emailConfigStatus" class="status-text"></span>
          </div>
          <p class="help-text">
            <strong>Lưu ý:</strong> Với Gmail, bạn cần tạo
            <a
              href="https://support.google.com/accounts/answer/185833"
              target="_blank"
              >App Password</a
            >
            (không dùng mật khẩu Gmail thường). Bật 2FA trước khi tạo App
            Password.
          </p>
        </div>
      </section>

      <!-- Bulk Actions Section -->
      <section class="card bulk-section" id="bulkSection" style="display: none">
        <h2>Thao tác hàng loạt</h2>
        <div class="bulk-form">
          <div class="form-row">
            <div class="form-group">
              <label>Tháng:</label>
              <select id="bulkMonth" class="date-select"></select>
            </div>
            <div class="form-group">
              <label>Năm:</label>
              <select id="bulkYear" class="date-select"></select>
            </div>
            <div class="form-group">
              <label>Loại file:</label>
              <select id="bulkFileType" class="date-select">
                <option value="pdf">PDF</option>
                <option value="excel">Excel</option>
              </select>
            </div>
          </div>
          <div class="bulk-actions">
            <button
              type="button"
              class="btn btn-excel"
              onclick="downloadAllSlips()"
            >
              Tải tất cả phiếu lương
            </button>
            <button
              type="button"
              class="btn btn-email"
              onclick="sendAllEmails()"
            >
              Gửi email tất cả
            </button>
          </div>
          <div id="bulkStatus" class="bulk-status" style="display: none"></div>
        </div>
      </section>

      <!-- Employee Selection Section -->
      <section
        class="card employee-section"
        id="employeeSection"
        style="display: none"
      >
        <h2>Chọn Nhân viên</h2>
        <div class="employee-select-row">
          <select id="employeeSelect" class="employee-dropdown">
            <option value="">-- Chọn nhân viên --</option>
          </select>
          <button
            type="button"
            class="btn btn-primary"
            onclick="loadSelectedEmployee()"
          >
            Xem thông tin
          </button>
        </div>

        <div class="search-alternative">
          <p>Hoặc tìm kiếm theo từ khóa:</p>
          <div class="search-row">
            <input
              type="text"
              id="searchInput"
              placeholder="Nhập tên hoặc thông tin cần tìm..."
            />
            <button
              type="button"
              class="btn btn-secondary"
              onclick="searchEmployee()"
            >
              Tìm kiếm
            </button>
          </div>
        </div>
      </section>

      <!-- Results Section -->
      <section
        class="card results-section"
        id="resultsSection"
        style="display: none"
      >
        <h2>Thông tin Nhân viên</h2>
        <p class="result-count">
          Tìm thấy <span id="resultCount">0</span> kết quả
        </p>
        <div id="resultsContainer"></div>
      </section>
    </div>

    <script>
      let employeesList = [];
      let emailStatusMap = {};

      // Get current month and year
      const now = new Date();
      const currentMonth = now.getMonth() + 1;
      const currentYear = now.getFullYear();

      // Initialize month/year selectors
      function initDateSelectors() {
          const bulkMonth = document.getElementById('bulkMonth');
          const bulkYear = document.getElementById('bulkYear');

          bulkMonth.innerHTML = buildMonthOptions(currentMonth);
          bulkYear.innerHTML = buildYearOptions(currentYear);
      }

      // File input display
      document.getElementById('fileInput').addEventListener('change', function(e) {
          const fileName = e.target.files[0]?.name || '';
          document.getElementById('fileName').textContent = fileName;
          document.querySelector('.file-text').textContent = fileName || 'Chọn file Excel (.xlsx, .xls)';
      });

      // Upload form
      document.getElementById('uploadForm').addEventListener('submit', async function(e) {
          e.preventDefault();
          const fileInput = document.getElementById('fileInput');
          const statusDiv = document.getElementById('uploadStatus');

          if (!fileInput.files[0]) {
              statusDiv.innerHTML = '<span class="error">Vui lòng chọn file!</span>';
              return;
          }

          const formData = new FormData();
          formData.append('file', fileInput.files[0]);

          statusDiv.innerHTML = '<span class="loading">Đang xử lý...</span>';

          try {
              const response = await fetch('/upload', {
                  method: 'POST',
                  body: formData
              });
              const data = await response.json();

              if (data.success) {
                  statusDiv.innerHTML = '<span class="success">' + data.message + '</span>';
                  document.getElementById('employeeCount').textContent = data.total_employees;
                  document.getElementById('dataInfo').style.display = 'block';
                  document.getElementById('employeeSection').style.display = 'block';
                  document.getElementById('bulkSection').style.display = 'block';
                  document.getElementById('emailConfigSection').style.display = 'block';
                  document.getElementById('emailSummarySection').style.display = 'block';

                  employeesList = data.employees_list || [];
                  emailStatusMap = {};
                  updateEmployeeDropdown(employeesList);
                  updateEmailSummary();
                  initDateSelectors();
              } else {
                  statusDiv.innerHTML = '<span class="error">' + data.error + '</span>';
              }
          } catch (error) {
              statusDiv.innerHTML = '<span class="error">Lỗi kết nối: ' + error.message + '</span>';
          }
      });

      // Update email summary stats
      function updateEmailSummary() {
          const total = employeesList.length;
          let sent = 0;
          let failed = 0;
          
          for (const emp of employeesList) {
              const status = emailStatusMap[emp.index];
              if (status) {
                  if (status.success) {
                      sent++;
                  } else {
                      failed++;
                  }
              }
          }
          
          const pending = total - sent - failed;
          
          document.getElementById('statTotal').textContent = total;
          document.getElementById('statSent').textContent = sent;
          document.getElementById('statPending').textContent = pending;
          document.getElementById('statFailed').textContent = failed;
      }

      // Show email list by filter
      function showEmailList(filter) {
          const container = document.getElementById('emailListContainer');
          const tbody = document.getElementById('emailListBody');
          container.style.display = 'block';
          
          let html = '';
          let count = 0;
          
          employeesList.forEach((emp, idx) => {
              const status = emailStatusMap[emp.index];
              let statusText = 'Chưa gửi';
              let statusClass = 'status-pending';
              let timeText = '-';
              
              if (status) {
                  if (status.success) {
                      statusText = 'Đã gửi';
                      statusClass = 'status-sent';
                      timeText = status.time || '-';
                  } else {
                      statusText = 'Thất bại';
                      statusClass = 'status-failed';
                      timeText = status.time || '-';
                  }
              }
              
              // Apply filter
              if (filter === 'pending' && status) return;
              if (filter === 'sent' && (!status || !status.success)) return;
              
              count++;
              html += `
                  <tr>
                      <td>${count}</td>
                      <td>${emp.name}</td>
                      <td>${emp.email || 'Không có'}</td>
                      <td><span class="${statusClass}">${statusText}</span></td>
                      <td>${timeText}</td>
                  </tr>
              `;
          });
          
          if (!html) {
              html = '<tr><td colspan="5" style="text-align:center">Không có dữ liệu</td></tr>';
          }
          
          tbody.innerHTML = html;
      }

      // Update employee dropdown with email status
      function updateEmployeeDropdown(employees) {
          const select = document.getElementById('employeeSelect');
          select.innerHTML = '<option value="">-- Chọn nhân viên --</option>';

          employees.forEach(emp => {
              const option = document.createElement('option');
              option.value = emp.index;
              
              // Show email status in dropdown
              const status = emailStatusMap[emp.index];
              let statusMark = '';
              if (status) {
                  statusMark = status.success ? ' [DA GUI]' : ' [THAT BAI]';
              } else {
                  statusMark = ' [CHUA GUI]';
              }
              
              let text = emp.name + statusMark;
              if (emp.email) {
                  text += ` - ${emp.email}`;
              }
              option.textContent = text;
              select.appendChild(option);
          });
      }

      // Load selected employee
      async function loadSelectedEmployee() {
          const select = document.getElementById('employeeSelect');
          const index = select.value;

          if (!index) {
              alert('Vui lòng chọn nhân viên!');
              return;
          }

          try {
              const response = await fetch('/get_employee/' + index);
              const data = await response.json();

              if (data.success) {
                  displayResults([data.result]);
                  document.getElementById('resultCount').textContent = 1;
                  document.getElementById('resultsSection').style.display = 'block';
              } else {
                  alert(data.error);
              }
          } catch (error) {
              alert('Lỗi: ' + error.message);
          }
      }

      // Search employee
      async function searchEmployee() {
          const searchTerm = document.getElementById('searchInput').value.trim();

          if (!searchTerm) {
              alert('Vui lòng nhập từ khóa tìm kiếm!');
              return;
          }

          try {
              const response = await fetch('/search', {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json'
                  },
                  body: JSON.stringify({
                      search_term: searchTerm,
                      search_fields: []
                  })
              });
              const data = await response.json();

              if (data.success) {
                  displayResults(data.results);
                  document.getElementById('resultCount').textContent = data.count;
                  document.getElementById('resultsSection').style.display = 'block';
              } else {
                  alert(data.error);
                  document.getElementById('resultsSection').style.display = 'none';
              }
          } catch (error) {
              alert('Lỗi: ' + error.message);
          }
      }

      // Enter key search
      document.getElementById('searchInput').addEventListener('keypress', function(e) {
          if (e.key === 'Enter') {
              searchEmployee();
          }
      });

      // Build month options
      function buildMonthOptions(selectedMonth) {
          let options = '';
          const months = [
              'Tháng 1', 'Tháng 2', 'Tháng 3', 'Tháng 4', 'Tháng 5', 'Tháng 6',
              'Tháng 7', 'Tháng 8', 'Tháng 9', 'Tháng 10', 'Tháng 11', 'Tháng 12'
          ];
          for (let i = 1; i <= 12; i++) {
              const selected = i === selectedMonth ? 'selected' : '';
              options += `<option value="${i}" ${selected}>${months[i-1]}</option>`;
          }
          return options;
      }

      // Build year options
      function buildYearOptions(selectedYear) {
          let options = '';
          for (let y = selectedYear - 5; y <= selectedYear + 1; y++) {
              const selected = y === selectedYear ? 'selected' : '';
              options += `<option value="${y}" ${selected}>${y}</option>`;
          }
          return options;
      }

      // Get email status badge
      function getEmailStatusBadge(emailStatus) {
          if (!emailStatus) {
              return '<span class="badge badge-pending">CHUA GUI</span>';
          }
          if (emailStatus.success) {
              return `<span class="badge badge-success">DA GUI - ${emailStatus.time}</span>`;
          }
          return `<span class="badge badge-error" title="${emailStatus.message}">THAT BAI</span>`;
      }

      // Display search results
      function displayResults(results) {
          const container = document.getElementById('resultsContainer');
          container.innerHTML = '';

          results.forEach(result => {
              const card = document.createElement('div');
              card.className = 'result-card';

              // Get employee name and email
              let employeeName = 'Nhân viên';
              let employeeEmail = result.email || null;

              for (const key of Object.keys(result.info)) {
                  if (key.toLowerCase().includes('họ tên') || key.toLowerCase().includes('ho ten')) {
                      employeeName = result.info[key];
                      break;
                  }
              }

              // Email status
              const emailStatus = result.email_status || emailStatusMap[result.index];
              const emailBadge = getEmailStatusBadge(emailStatus);

              let html = `
                  <div class="result-header">
                      <h3>${employeeName}</h3>
                      <div class="email-status-wrapper">
                          ${emailBadge}
                      </div>
                  </div>
              `;

              // Info section
              html += '<div class="result-section"><h4>Thông tin cá nhân</h4><div class="info-grid">';
              for (const [key, value] of Object.entries(result.info)) {
                  html += `<div class="info-item"><span class="info-label">${key}:</span><span class="info-value">${value}</span></div>`;
              }
              html += '</div></div>';

              // Salary section
              if (result.salary) {
                  html += '<div class="result-section salary-section"><h4>Thông tin lương</h4><div class="info-grid">';
                  for (const [key, value] of Object.entries(result.salary)) {
                      let displayValue = value;
                      const numValue = parseFloat(value);
                      if (!isNaN(numValue) && numValue > 1000) {
                          displayValue = numValue.toLocaleString('vi-VN');
                      }
                      html += `<div class="info-item"><span class="info-label">${key}:</span><span class="info-value">${displayValue}</span></div>`;
                  }
                  html += '</div></div>';
              }

              // Export section with month/year selection
              html += `
                  <div class="result-section export-section">
                      <h4>Xuất Phiếu Lương</h4>
                      <div class="export-form">
                          <div class="date-selectors">
                              <div class="date-field">
                                  <label>Tháng:</label>
                                  <select id="month_${result.index}" class="date-select">
                                      ${buildMonthOptions(currentMonth)}
                                  </select>
                              </div>
                              <div class="date-field">
                                  <label>Năm:</label>
                                  <select id="year_${result.index}" class="date-select">
                                      ${buildYearOptions(currentYear)}
                                  </select>
                              </div>
                          </div>
                          <div class="export-buttons">
                              <button class="btn btn-excel" onclick="exportFile(${result.index}, 'excel')">
                                  Xuất Excel
                              </button>
                              <button class="btn btn-pdf" onclick="exportFile(${result.index}, 'pdf')">
                                  Xuất PDF
                              </button>
                          </div>
                      </div>
                  </div>
              `;

              // Email section
              if (employeeEmail) {
                  html += `
                      <div class="result-section email-section">
                          <h4>Gửi Email</h4>
                          <div class="email-form">
                              <p class="email-info">Email: <strong>${employeeEmail}</strong></p>
                              <div class="email-actions">
                                  <select id="emailFileType_${result.index}" class="date-select">
                                      <option value="pdf">PDF</option>
                                      <option value="excel">Excel</option>
                                  </select>
                                  <button class="btn btn-email" onclick="sendEmail(${result.index})" id="sendBtn_${result.index}">
                                      Gửi phiếu lương
                                  </button>
                              </div>
                              <div id="emailStatus_${result.index}" class="email-result"></div>
                          </div>
                      </div>
                  `;
              } else {
                  html += `
                      <div class="result-section email-section">
                          <h4>Gửi Email</h4>
                          <p class="no-email">Không tìm thấy email của nhân viên trong dữ liệu</p>
                      </div>
                  `;
              }

              card.innerHTML = html;
              container.appendChild(card);
          });
      }

      // Export file with month/year
      function exportFile(index, type) {
          const month = document.getElementById('month_' + index).value;
          const year = document.getElementById('year_' + index).value;
          window.location.href = `/export/${type}/${index}?month=${month}&year=${year}`;
      }

      // Send email to single employee
      async function sendEmail(index) {
          const month = document.getElementById('month_' + index).value;
          const year = document.getElementById('year_' + index).value;
          const fileType = document.getElementById('emailFileType_' + index).value;
          const statusDiv = document.getElementById('emailStatus_' + index);
          const sendBtn = document.getElementById('sendBtn_' + index);

          sendBtn.disabled = true;
          sendBtn.textContent = 'Đang gửi...';
          statusDiv.innerHTML = '<span class="loading">Đang gửi email...</span>';

          try {
              const response = await fetch('/send_email/' + index, {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json'
                  },
                  body: JSON.stringify({
                      month: parseInt(month),
                      year: parseInt(year),
                      file_type: fileType
                  })
              });
              const data = await response.json();

              if (data.success) {
                  statusDiv.innerHTML = '<span class="success">' + data.message + '</span>';
                  emailStatusMap[index] = data.email_status;
                  // Update badge
                  const card = sendBtn.closest('.result-card');
                  const badgeWrapper = card.querySelector('.email-status-wrapper');
                  if (badgeWrapper) {
                      badgeWrapper.innerHTML = getEmailStatusBadge(data.email_status);
                  }
                  // Update summary and dropdown
                  updateEmailSummary();
                  updateEmployeeDropdown(employeesList);
              } else {
                  statusDiv.innerHTML = '<span class="error">' + (data.error || data.message) + '</span>';
              }
          } catch (error) {
              statusDiv.innerHTML = '<span class="error">Lỗi: ' + error.message + '</span>';
          }

          sendBtn.disabled = false;
          sendBtn.textContent = 'Gửi phiếu lương';
      }

      // Save email configuration
      async function saveEmailConfig() {
          const config = {
              smtp_server: document.getElementById('smtpServer').value,
              smtp_port: document.getElementById('smtpPort').value,
              sender_email: document.getElementById('senderEmail').value,
              sender_password: document.getElementById('senderPassword').value
          };

          const statusSpan = document.getElementById('emailConfigStatus');
          statusSpan.textContent = 'Đang lưu...';
          statusSpan.className = 'status-text loading';

          try {
              const response = await fetch('/configure_email', {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json'
                  },
                  body: JSON.stringify(config)
              });
              const data = await response.json();

              if (data.success) {
                  statusSpan.textContent = data.message;
                  statusSpan.className = 'status-text success';
              } else {
                  statusSpan.textContent = data.error;
                  statusSpan.className = 'status-text error';
              }
          } catch (error) {
              statusSpan.textContent = 'Lỗi: ' + error.message;
              statusSpan.className = 'status-text error';
          }
      }

      // Download all salary slips as zip
      async function downloadAllSlips() {
          const month = document.getElementById('bulkMonth').value;
          const year = document.getElementById('bulkYear').value;
          const fileType = document.getElementById('bulkFileType').value;
          const statusDiv = document.getElementById('bulkStatus');

          statusDiv.style.display = 'block';
          statusDiv.innerHTML = '<span class="loading">Đang tạo file ZIP chứa tất cả phiếu lương...</span>';

          try {
              const response = await fetch('/export/bulk', {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json'
                  },
                  body: JSON.stringify({
                      indices: 'all',
                      file_type: fileType,
                      month: parseInt(month),
                      year: parseInt(year)
                  })
              });

              if (response.ok) {
                  const blob = await response.blob();
                  const url = window.URL.createObjectURL(blob);
                  const a = document.createElement('a');
                  a.href = url;
                  a.download = `PhieuLuong_Thang${month}_${year}.zip`;
                  document.body.appendChild(a);
                  a.click();
                  a.remove();
                  window.URL.revokeObjectURL(url);
                  statusDiv.innerHTML = '<span class="success">Đã tải xuống thành công!</span>';
              } else {
                  const data = await response.json();
                  statusDiv.innerHTML = '<span class="error">' + (data.error || 'Lỗi tải file') + '</span>';
              }
          } catch (error) {
              statusDiv.innerHTML = '<span class="error">Lỗi: ' + error.message + '</span>';
          }
      }

      // Send emails to all employees
      async function sendAllEmails() {
          const month = document.getElementById('bulkMonth').value;
          const year = document.getElementById('bulkYear').value;
          const fileType = document.getElementById('bulkFileType').value;
          const statusDiv = document.getElementById('bulkStatus');

          if (!confirm(`Bạn có chắc muốn gửi email phiếu lương tháng ${month}/${year} cho TẤT CẢ nhân viên?`)) {
              return;
          }

          statusDiv.style.display = 'block';
          statusDiv.innerHTML = '<span class="loading">Đang gửi email cho tất cả nhân viên...</span>';

          try {
              const response = await fetch('/send_email_bulk', {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json'
                  },
                  body: JSON.stringify({
                      indices: 'all',
                      file_type: fileType,
                      month: parseInt(month),
                      year: parseInt(year)
                  })
              });
              const data = await response.json();

              if (data.success) {
                  let html = `<div class="bulk-result">
                      <p class="success-summary">${data.message}</p>
                      <div class="result-details">`;

                  data.results.forEach(r => {
                      const statusClass = r.success ? 'success' : 'error';
                      const icon = r.success ? '[OK]' : '[X]';
                      html += `<div class="result-item ${statusClass}">${icon} ${r.name}: ${r.message}</div>`;

                      // Update email status map
                      emailStatusMap[r.index] = {
                          sent: true,
                          success: r.success,
                          message: r.message,
                          time: new Date().toLocaleString('vi-VN')
                      };
                  });

                  html += '</div></div>';
                  statusDiv.innerHTML = html;
                  
                  // Update summary and dropdown
                  updateEmailSummary();
                  updateEmployeeDropdown(employeesList);
              } else {
                  statusDiv.innerHTML = '<span class="error">' + data.error + '</span>';
              }
          } catch (error) {
              statusDiv.innerHTML = '<span class="error">Lỗi: ' + error.message + '</span>';
          }
      }

      // Initialize if data exists
      {% if has_data %}
      document.getElementById('employeeSection').style.display = 'block';
      document.getElementById('dataInfo').style.display = 'block';
      document.getElementById('bulkSection').style.display = 'block';
      document.getElementById('emailConfigSection').style.display = 'block';
      document.getElementById('emailSummarySection').style.display = 'block';
      employeesList = {{ employees_list | tojson }};
      emailStatusMap = {{ email_status | tojson }};
      updateEmployeeDropdown(employeesList);
      updateEmailSummary();
      initDateSelectors();
      {% endif %}
    </script>
  </body>
</html>
