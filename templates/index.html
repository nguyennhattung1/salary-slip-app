<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Qu·∫£n l√Ω Nh√¢n s·ª± & Xu·∫•t Phi·∫øu L∆∞∆°ng</title>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='style.css') }}"
    />
  </head>
  <body>
    <div class="container">
      <header>
        <h1>Qu·∫£n l√Ω Nh√¢n s·ª± & Xu·∫•t Phi·∫øu L∆∞∆°ng</h1>
        <p class="subtitle">
          Upload file Excel, ch·ªçn nh√¢n vi√™n v√† xu·∫•t phi·∫øu l∆∞∆°ng c√° nh√¢n
        </p>
      </header>

      <!-- Upload Section -->
      <section class="card upload-section">
        <h2>üìÅ Upload File Excel</h2>
        <form id="uploadForm" enctype="multipart/form-data">
          <div class="file-input-wrapper">
            <input type="file" id="fileInput" name="file" accept=".xlsx,.xls" />
            <label for="fileInput" class="file-label">
              <span class="file-icon">üìÑ</span>
              <span class="file-text">Ch·ªçn file Excel (.xlsx, .xls)</span>
            </label>
            <span id="fileName" class="file-name"></span>
          </div>
          <button type="submit" class="btn btn-primary">Upload</button>
        </form>
        <div id="uploadStatus" class="status-message"></div>
        <div id="dataInfo" class="data-info" style="display: none">
          <p>
            <strong>S·ªë nh√¢n vi√™n:</strong> <span id="employeeCount">0</span>
          </p>
        </div>
      </section>

      <!-- Email Configuration Section -->
      <section
        class="card email-config-section"
        id="emailConfigSection"
        style="display: none"
      >
        <h2>üìß C·∫•u h√¨nh Email</h2>
        <div class="email-config-form">
          <div class="form-row">
            <div class="form-group">
              <label>SMTP Server:</label>
              <input
                type="text"
                id="smtpServer"
                value="smtp.gmail.com"
                placeholder="smtp.gmail.com"
              />
            </div>
            <div class="form-group">
              <label>Port:</label>
              <input
                type="number"
                id="smtpPort"
                value="587"
                placeholder="587"
              />
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Email g·ª≠i:</label>
              <input
                type="email"
                id="senderEmail"
                placeholder="your-email@gmail.com"
              />
            </div>
            <div class="form-group">
              <label>App Password:</label>
              <input
                type="password"
                id="senderPassword"
                placeholder="App Password (kh√¥ng ph·∫£i m·∫≠t kh·∫©u Gmail)"
              />
            </div>
          </div>
          <div class="form-actions">
            <button
              type="button"
              class="btn btn-primary"
              onclick="saveEmailConfig()"
            >
              üíæ L∆∞u c·∫•u h√¨nh
            </button>
            <span id="emailConfigStatus" class="status-text"></span>
          </div>
          <p class="help-text">
            <strong>L∆∞u √Ω:</strong> V·ªõi Gmail, b·∫°n c·∫ßn t·∫°o
            <a
              href="https://support.google.com/accounts/answer/185833"
              target="_blank"
              >App Password</a
            >
            (kh√¥ng d√πng m·∫≠t kh·∫©u Gmail th∆∞·ªùng). B·∫≠t 2FA tr∆∞·ªõc khi t·∫°o App
            Password.
          </p>
        </div>
      </section>

      <!-- Bulk Actions Section -->
      <section class="card bulk-section" id="bulkSection" style="display: none">
        <h2>‚ö° Thao t√°c h√†ng lo·∫°t</h2>
        <div class="bulk-form">
          <div class="form-row">
            <div class="form-group">
              <label>Th√°ng:</label>
              <select id="bulkMonth" class="date-select"></select>
            </div>
            <div class="form-group">
              <label>NƒÉm:</label>
              <select id="bulkYear" class="date-select"></select>
            </div>
            <div class="form-group">
              <label>Lo·∫°i file:</label>
              <select id="bulkFileType" class="date-select">
                <option value="pdf">PDF</option>
                <option value="excel">Excel</option>
              </select>
            </div>
          </div>
          <div class="bulk-actions">
            <button
              type="button"
              class="btn btn-excel"
              onclick="downloadAllSlips()"
            >
              üì• T·∫£i t·∫•t c·∫£ phi·∫øu l∆∞∆°ng
            </button>
            <button
              type="button"
              class="btn btn-email"
              onclick="sendAllEmails()"
            >
              üì® G·ª≠i email t·∫•t c·∫£
            </button>
          </div>
          <div id="bulkStatus" class="bulk-status" style="display: none"></div>
        </div>
      </section>

      <!-- Employee Selection Section -->
      <section
        class="card employee-section"
        id="employeeSection"
        style="display: none"
      >
        <h2>üë§ Ch·ªçn Nh√¢n vi√™n</h2>
        <div class="employee-select-row">
          <select id="employeeSelect" class="employee-dropdown">
            <option value="">-- Ch·ªçn nh√¢n vi√™n --</option>
          </select>
          <button
            type="button"
            class="btn btn-primary"
            onclick="loadSelectedEmployee()"
          >
            Xem th√¥ng tin
          </button>
        </div>

        <div class="search-alternative">
          <p>Ho·∫∑c t√¨m ki·∫øm theo t·ª´ kh√≥a:</p>
          <div class="search-row">
            <input
              type="text"
              id="searchInput"
              placeholder="Nh·∫≠p t√™n ho·∫∑c th√¥ng tin c·∫ßn t√¨m..."
            />
            <button
              type="button"
              class="btn btn-secondary"
              onclick="searchEmployee()"
            >
              T√¨m ki·∫øm
            </button>
          </div>
        </div>
      </section>

      <!-- Results Section -->
      <section
        class="card results-section"
        id="resultsSection"
        style="display: none"
      >
        <h2>üìã Th√¥ng tin Nh√¢n vi√™n</h2>
        <p class="result-count">
          T√¨m th·∫•y <span id="resultCount">0</span> k·∫øt qu·∫£
        </p>
        <div id="resultsContainer"></div>
      </section>
    </div>

    <script>
      let employeesList = [];
      let emailStatusMap = {};

      // Get current month and year
      const now = new Date();
      const currentMonth = now.getMonth() + 1;
      const currentYear = now.getFullYear();

      // Initialize month/year selectors
      function initDateSelectors() {
          const bulkMonth = document.getElementById('bulkMonth');
          const bulkYear = document.getElementById('bulkYear');

          bulkMonth.innerHTML = buildMonthOptions(currentMonth);
          bulkYear.innerHTML = buildYearOptions(currentYear);
      }

      // File input display
      document.getElementById('fileInput').addEventListener('change', function(e) {
          const fileName = e.target.files[0]?.name || '';
          document.getElementById('fileName').textContent = fileName;
          document.querySelector('.file-text').textContent = fileName || 'Ch·ªçn file Excel (.xlsx, .xls)';
      });

      // Upload form
      document.getElementById('uploadForm').addEventListener('submit', async function(e) {
          e.preventDefault();
          const fileInput = document.getElementById('fileInput');
          const statusDiv = document.getElementById('uploadStatus');

          if (!fileInput.files[0]) {
              statusDiv.innerHTML = '<span class="error">Vui l√≤ng ch·ªçn file!</span>';
              return;
          }

          const formData = new FormData();
          formData.append('file', fileInput.files[0]);

          statusDiv.innerHTML = '<span class="loading">ƒêang x·ª≠ l√Ω...</span>';

          try {
              const response = await fetch('/upload', {
                  method: 'POST',
                  body: formData
              });
              const data = await response.json();

              if (data.success) {
                  statusDiv.innerHTML = '<span class="success">' + data.message + '</span>';
                  document.getElementById('employeeCount').textContent = data.total_employees;
                  document.getElementById('dataInfo').style.display = 'block';
                  document.getElementById('employeeSection').style.display = 'block';
                  document.getElementById('bulkSection').style.display = 'block';
                  document.getElementById('emailConfigSection').style.display = 'block';

                  employeesList = data.employees_list || [];
                  updateEmployeeDropdown(employeesList);
                  initDateSelectors();
              } else {
                  statusDiv.innerHTML = '<span class="error">' + data.error + '</span>';
              }
          } catch (error) {
              statusDiv.innerHTML = '<span class="error">L·ªói k·∫øt n·ªëi: ' + error.message + '</span>';
          }
      });

      // Update employee dropdown
      function updateEmployeeDropdown(employees) {
          const select = document.getElementById('employeeSelect');
          select.innerHTML = '<option value="">-- Ch·ªçn nh√¢n vi√™n --</option>';

          employees.forEach(emp => {
              const option = document.createElement('option');
              option.value = emp.index;
              let text = emp.name;
              if (emp.email) {
                  text += ` (${emp.email})`;
              }
              option.textContent = text;
              select.appendChild(option);
          });
      }

      // Load selected employee
      async function loadSelectedEmployee() {
          const select = document.getElementById('employeeSelect');
          const index = select.value;

          if (!index) {
              alert('Vui l√≤ng ch·ªçn nh√¢n vi√™n!');
              return;
          }

          try {
              const response = await fetch('/get_employee/' + index);
              const data = await response.json();

              if (data.success) {
                  displayResults([data.result]);
                  document.getElementById('resultCount').textContent = 1;
                  document.getElementById('resultsSection').style.display = 'block';
              } else {
                  alert(data.error);
              }
          } catch (error) {
              alert('L·ªói: ' + error.message);
          }
      }

      // Search employee
      async function searchEmployee() {
          const searchTerm = document.getElementById('searchInput').value.trim();

          if (!searchTerm) {
              alert('Vui l√≤ng nh·∫≠p t·ª´ kh√≥a t√¨m ki·∫øm!');
              return;
          }

          try {
              const response = await fetch('/search', {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json'
                  },
                  body: JSON.stringify({
                      search_term: searchTerm,
                      search_fields: []
                  })
              });
              const data = await response.json();

              if (data.success) {
                  displayResults(data.results);
                  document.getElementById('resultCount').textContent = data.count;
                  document.getElementById('resultsSection').style.display = 'block';
              } else {
                  alert(data.error);
                  document.getElementById('resultsSection').style.display = 'none';
              }
          } catch (error) {
              alert('L·ªói: ' + error.message);
          }
      }

      // Enter key search
      document.getElementById('searchInput').addEventListener('keypress', function(e) {
          if (e.key === 'Enter') {
              searchEmployee();
          }
      });

      // Build month options
      function buildMonthOptions(selectedMonth) {
          let options = '';
          const months = [
              'Th√°ng 1', 'Th√°ng 2', 'Th√°ng 3', 'Th√°ng 4', 'Th√°ng 5', 'Th√°ng 6',
              'Th√°ng 7', 'Th√°ng 8', 'Th√°ng 9', 'Th√°ng 10', 'Th√°ng 11', 'Th√°ng 12'
          ];
          for (let i = 1; i <= 12; i++) {
              const selected = i === selectedMonth ? 'selected' : '';
              options += `<option value="${i}" ${selected}>${months[i-1]}</option>`;
          }
          return options;
      }

      // Build year options
      function buildYearOptions(selectedYear) {
          let options = '';
          for (let y = selectedYear - 5; y <= selectedYear + 1; y++) {
              const selected = y === selectedYear ? 'selected' : '';
              options += `<option value="${y}" ${selected}>${y}</option>`;
          }
          return options;
      }

      // Get email status badge
      function getEmailStatusBadge(emailStatus) {
          if (!emailStatus) {
              return '<span class="badge badge-pending">Ch∆∞a g·ª≠i</span>';
          }
          if (emailStatus.success) {
              return `<span class="badge badge-success">‚úì ƒê√£ g·ª≠i (${emailStatus.time})</span>`;
          }
          return `<span class="badge badge-error" title="${emailStatus.message}">‚úó G·ª≠i th·∫•t b·∫°i</span>`;
      }

      // Display search results
      function displayResults(results) {
          const container = document.getElementById('resultsContainer');
          container.innerHTML = '';

          results.forEach(result => {
              const card = document.createElement('div');
              card.className = 'result-card';

              // Get employee name and email
              let employeeName = 'Nh√¢n vi√™n';
              let employeeEmail = result.email || null;

              for (const key of Object.keys(result.info)) {
                  if (key.toLowerCase().includes('h·ªç t√™n') || key.toLowerCase().includes('ho ten')) {
                      employeeName = result.info[key];
                      break;
                  }
              }

              // Email status
              const emailStatus = result.email_status || emailStatusMap[result.index];
              const emailBadge = getEmailStatusBadge(emailStatus);

              let html = `
                  <div class="result-header">
                      <h3>${employeeName}</h3>
                      <div class="email-status-wrapper">
                          ${emailBadge}
                      </div>
                  </div>
              `;

              // Info section
              html += '<div class="result-section"><h4>Th√¥ng tin c√° nh√¢n</h4><div class="info-grid">';
              for (const [key, value] of Object.entries(result.info)) {
                  html += `<div class="info-item"><span class="info-label">${key}:</span><span class="info-value">${value}</span></div>`;
              }
              html += '</div></div>';

              // Salary section
              if (result.salary) {
                  html += '<div class="result-section salary-section"><h4>Th√¥ng tin l∆∞∆°ng</h4><div class="info-grid">';
                  for (const [key, value] of Object.entries(result.salary)) {
                      let displayValue = value;
                      const numValue = parseFloat(value);
                      if (!isNaN(numValue) && numValue > 1000) {
                          displayValue = numValue.toLocaleString('vi-VN');
                      }
                      html += `<div class="info-item"><span class="info-label">${key}:</span><span class="info-value">${displayValue}</span></div>`;
                  }
                  html += '</div></div>';
              }

              // Export section with month/year selection
              html += `
                  <div class="result-section export-section">
                      <h4>üì• Xu·∫•t Phi·∫øu L∆∞∆°ng</h4>
                      <div class="export-form">
                          <div class="date-selectors">
                              <div class="date-field">
                                  <label>Th√°ng:</label>
                                  <select id="month_${result.index}" class="date-select">
                                      ${buildMonthOptions(currentMonth)}
                                  </select>
                              </div>
                              <div class="date-field">
                                  <label>NƒÉm:</label>
                                  <select id="year_${result.index}" class="date-select">
                                      ${buildYearOptions(currentYear)}
                                  </select>
                              </div>
                          </div>
                          <div class="export-buttons">
                              <button class="btn btn-excel" onclick="exportFile(${result.index}, 'excel')">
                                  üìä Xu·∫•t Excel
                              </button>
                              <button class="btn btn-pdf" onclick="exportFile(${result.index}, 'pdf')">
                                  üìÑ Xu·∫•t PDF
                              </button>
                          </div>
                      </div>
                  </div>
              `;

              // Email section
              if (employeeEmail) {
                  html += `
                      <div class="result-section email-section">
                          <h4>üìß G·ª≠i Email</h4>
                          <div class="email-form">
                              <p class="email-info">Email: <strong>${employeeEmail}</strong></p>
                              <div class="email-actions">
                                  <select id="emailFileType_${result.index}" class="date-select">
                                      <option value="pdf">PDF</option>
                                      <option value="excel">Excel</option>
                                  </select>
                                  <button class="btn btn-email" onclick="sendEmail(${result.index})" id="sendBtn_${result.index}">
                                      üì® G·ª≠i phi·∫øu l∆∞∆°ng
                                  </button>
                              </div>
                              <div id="emailStatus_${result.index}" class="email-result"></div>
                          </div>
                      </div>
                  `;
              } else {
                  html += `
                      <div class="result-section email-section">
                          <h4>üìß G·ª≠i Email</h4>
                          <p class="no-email">‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y email c·ªßa nh√¢n vi√™n trong d·ªØ li·ªáu</p>
                      </div>
                  `;
              }

              card.innerHTML = html;
              container.appendChild(card);
          });
      }

      // Export file with month/year
      function exportFile(index, type) {
          const month = document.getElementById('month_' + index).value;
          const year = document.getElementById('year_' + index).value;
          window.location.href = `/export/${type}/${index}?month=${month}&year=${year}`;
      }

      // Send email to single employee
      async function sendEmail(index) {
          const month = document.getElementById('month_' + index).value;
          const year = document.getElementById('year_' + index).value;
          const fileType = document.getElementById('emailFileType_' + index).value;
          const statusDiv = document.getElementById('emailStatus_' + index);
          const sendBtn = document.getElementById('sendBtn_' + index);

          sendBtn.disabled = true;
          sendBtn.textContent = '‚è≥ ƒêang g·ª≠i...';
          statusDiv.innerHTML = '<span class="loading">ƒêang g·ª≠i email...</span>';

          try {
              const response = await fetch('/send_email/' + index, {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json'
                  },
                  body: JSON.stringify({
                      month: parseInt(month),
                      year: parseInt(year),
                      file_type: fileType
                  })
              });
              const data = await response.json();

              if (data.success) {
                  statusDiv.innerHTML = '<span class="success">‚úì ' + data.message + '</span>';
                  emailStatusMap[index] = data.email_status;
                  // Update badge
                  const card = sendBtn.closest('.result-card');
                  const badgeWrapper = card.querySelector('.email-status-wrapper');
                  if (badgeWrapper) {
                      badgeWrapper.innerHTML = getEmailStatusBadge(data.email_status);
                  }
              } else {
                  statusDiv.innerHTML = '<span class="error">‚úó ' + (data.error || data.message) + '</span>';
              }
          } catch (error) {
              statusDiv.innerHTML = '<span class="error">‚úó L·ªói: ' + error.message + '</span>';
          }

          sendBtn.disabled = false;
          sendBtn.textContent = 'üì® G·ª≠i phi·∫øu l∆∞∆°ng';
      }

      // Save email configuration
      async function saveEmailConfig() {
          const config = {
              smtp_server: document.getElementById('smtpServer').value,
              smtp_port: document.getElementById('smtpPort').value,
              sender_email: document.getElementById('senderEmail').value,
              sender_password: document.getElementById('senderPassword').value
          };

          const statusSpan = document.getElementById('emailConfigStatus');
          statusSpan.textContent = 'ƒêang l∆∞u...';
          statusSpan.className = 'status-text loading';

          try {
              const response = await fetch('/configure_email', {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json'
                  },
                  body: JSON.stringify(config)
              });
              const data = await response.json();

              if (data.success) {
                  statusSpan.textContent = '‚úì ' + data.message;
                  statusSpan.className = 'status-text success';
              } else {
                  statusSpan.textContent = '‚úó ' + data.error;
                  statusSpan.className = 'status-text error';
              }
          } catch (error) {
              statusSpan.textContent = '‚úó L·ªói: ' + error.message;
              statusSpan.className = 'status-text error';
          }
      }

      // Download all salary slips as zip
      async function downloadAllSlips() {
          const month = document.getElementById('bulkMonth').value;
          const year = document.getElementById('bulkYear').value;
          const fileType = document.getElementById('bulkFileType').value;
          const statusDiv = document.getElementById('bulkStatus');

          statusDiv.style.display = 'block';
          statusDiv.innerHTML = '<span class="loading">‚è≥ ƒêang t·∫°o file ZIP ch·ª©a t·∫•t c·∫£ phi·∫øu l∆∞∆°ng...</span>';

          try {
              const response = await fetch('/export/bulk', {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json'
                  },
                  body: JSON.stringify({
                      indices: 'all',
                      file_type: fileType,
                      month: parseInt(month),
                      year: parseInt(year)
                  })
              });

              if (response.ok) {
                  const blob = await response.blob();
                  const url = window.URL.createObjectURL(blob);
                  const a = document.createElement('a');
                  a.href = url;
                  a.download = `PhieuLuong_Thang${month}_${year}.zip`;
                  document.body.appendChild(a);
                  a.click();
                  a.remove();
                  window.URL.revokeObjectURL(url);
                  statusDiv.innerHTML = '<span class="success">‚úì ƒê√£ t·∫£i xu·ªëng th√†nh c√¥ng!</span>';
              } else {
                  const data = await response.json();
                  statusDiv.innerHTML = '<span class="error">‚úó ' + (data.error || 'L·ªói t·∫£i file') + '</span>';
              }
          } catch (error) {
              statusDiv.innerHTML = '<span class="error">‚úó L·ªói: ' + error.message + '</span>';
          }
      }

      // Send emails to all employees
      async function sendAllEmails() {
          const month = document.getElementById('bulkMonth').value;
          const year = document.getElementById('bulkYear').value;
          const fileType = document.getElementById('bulkFileType').value;
          const statusDiv = document.getElementById('bulkStatus');

          if (!confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën g·ª≠i email phi·∫øu l∆∞∆°ng th√°ng ${month}/${year} cho T·∫§T C·∫¢ nh√¢n vi√™n?`)) {
              return;
          }

          statusDiv.style.display = 'block';
          statusDiv.innerHTML = '<span class="loading">‚è≥ ƒêang g·ª≠i email cho t·∫•t c·∫£ nh√¢n vi√™n...</span>';

          try {
              const response = await fetch('/send_email_bulk', {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json'
                  },
                  body: JSON.stringify({
                      indices: 'all',
                      file_type: fileType,
                      month: parseInt(month),
                      year: parseInt(year)
                  })
              });
              const data = await response.json();

              if (data.success) {
                  let html = `<div class="bulk-result">
                      <p class="success-summary">‚úì ${data.message}</p>
                      <div class="result-details">`;

                  data.results.forEach(r => {
                      const statusClass = r.success ? 'success' : 'error';
                      const icon = r.success ? '‚úì' : '‚úó';
                      html += `<div class="result-item ${statusClass}">${icon} ${r.name}: ${r.message}</div>`;

                      // Update email status map
                      if (r.success) {
                          emailStatusMap[r.index] = {
                              sent: true,
                              success: true,
                              message: r.message,
                              time: new Date().toLocaleString('vi-VN')
                          };
                      }
                  });

                  html += '</div></div>';
                  statusDiv.innerHTML = html;
              } else {
                  statusDiv.innerHTML = '<span class="error">‚úó ' + data.error + '</span>';
              }
          } catch (error) {
              statusDiv.innerHTML = '<span class="error">‚úó L·ªói: ' + error.message + '</span>';
          }
      }

      // Initialize if data exists
      {% if has_data %}
      document.getElementById('employeeSection').style.display = 'block';
      document.getElementById('dataInfo').style.display = 'block';
      document.getElementById('bulkSection').style.display = 'block';
      document.getElementById('emailConfigSection').style.display = 'block';
      employeesList = {{ employees_list | tojson }};
      emailStatusMap = {{ email_status | tojson }};
      updateEmployeeDropdown(employeesList);
      initDateSelectors();
      {% endif %}
    </script>
  </body>
</html>
